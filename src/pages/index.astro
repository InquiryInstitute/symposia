---
import BaseLayout from '../layouts/BaseLayout.astro';
import { fetchSymposiaFromEdgeFunction, fetchFacultyByHandleFromEdgeFunction } from '../lib/supabase-edge-functions';
import type { Symposium } from '../lib/supabase-edge-functions';

const base = import.meta.env.BASE_URL;

// Fetch featured symposia from Supabase
let featuredSymposia: Symposium[] = [];
let facultyNames: Record<string, string> = {};

try {
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || 'https://pilmscrodlitdrygabvo.supabase.co';
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  
  if (!supabaseAnonKey) {
    console.warn('PUBLIC_SUPABASE_ANON_KEY not set - symposia will not load');
    console.warn('Set PUBLIC_SUPABASE_ANON_KEY in your environment or .env file');
  }
  
  featuredSymposia = await fetchSymposiaFromEdgeFunction(true);
  console.log(`Fetched ${featuredSymposia.length} featured symposia`);
  
  // Fetch faculty names for display
  const allFacultyIds = new Set<string>();
  featuredSymposia.forEach(s => {
    s.faculty?.forEach(id => allFacultyIds.add(id));
    if (s.heretic) allFacultyIds.add(s.heretic);
  });
  
  // Fetch faculty names in parallel
  const facultyPromises = Array.from(allFacultyIds).map(async (id) => {
    try {
      const faculty = await fetchFacultyByHandleFromEdgeFunction(id);
      if (faculty) {
        facultyNames[id] = faculty.surname 
          ? `${faculty.name} ${faculty.surname}` 
          : faculty.name;
      }
    } catch (error) {
      console.warn(`Failed to fetch faculty ${id}:`, error);
      // Use ID as fallback
      facultyNames[id] = id.replace(/^a[.-]/, '').replace(/[.-]/g, ' ');
    }
  });
  
  await Promise.all(facultyPromises);
} catch (error) {
  console.error('Failed to fetch symposia:', error);
  console.error('Error details:', error instanceof Error ? error.message : String(error));
  // Fallback to empty array - page will show "coming soon"
}

// Helper to get display name for faculty
function getFacultyDisplayName(id: string): string {
  return facultyNames[id] || id.replace(/^a[.-]/, '').replace(/[.-]/g, ' ');
}

// Helper to get flag/emoji for symposium
function getSymposiumFlag(slug: string): string {
  if (slug.includes('iran') || slug.includes('ayandeh')) return 'üáÆüá∑';
  if (slug.includes('absinthe')) return 'üçÉ';
  if (slug.includes('buddhist') || slug.includes('sangha')) return 'üïØÔ∏è';
  return 'üìö';
}

// Helper to get theme class
function getSymposiumTheme(slug: string, styleTheme?: string): string {
  if (slug.includes('iran') || slug.includes('ayandeh') || styleTheme === 'persian') return 'iran-theme';
  if (slug.includes('absinthe') || styleTheme === 'gothic') return 'absinthe-theme';
  if (styleTheme === 'greek') return 'greek-theme';
  return '';
}
---

<BaseLayout title="Home">
  <section class="hero">
    <div class="container">
      <h1>Symposia</h1>
      <p class="hero-tagline">A living archive of imagined dialogues between history's great minds.</p>
      <p class="hero-quote">"In dialogue, thought discovers itself."</p>
    </div>
  </section>

  <section class="intro container">
    <h2>About This Project</h2>
    <p>
      <strong>Symposia</strong> is an ongoing project by <a href="https://inquiry.institute">Inquiry Institute</a> 
      to record and publish imaginary symposia‚Äîconversations that never happened but perhaps should have. 
      Using the power of language models and careful historical research, we bring together thinkers 
      across time and tradition to address the questions that shape our world.
    </p>
    <p>
      These are not predictions or prescriptions. They are <em>explorations</em>‚Äîattempts to honor 
      the complexity of human thought by staging encounters between minds that, in their own times, 
      grappled with eternal questions.
    </p>
  </section>

  <section class="symposia-list container">
    <h2>Featured Symposia</h2>
    
    {featuredSymposia.length > 0 ? (
      featuredSymposia.map((symposium) => (
        <a href={`${base}${symposium.slug}/`} class={`symposium-card ${getSymposiumTheme(symposium.slug, symposium.styleTheme)}`}>
          <div class="symposium-card-flag">{getSymposiumFlag(symposium.slug)}</div>
          <div class="symposium-card-content">
            <h3>{symposium.title}</h3>
            {symposium.titleNative && (
              <p class="symposium-card-native">{symposium.titleNative}</p>
            )}
            {symposium.titleTranslation && (
              <p class="symposium-card-subtitle">{symposium.titleTranslation}</p>
            )}
            {symposium.description && (
              <p class="symposium-card-desc">{symposium.description}</p>
            )}
            <div class="symposium-card-speakers">
              {symposium.faculty?.map((facultyId) => (
                <span>{getFacultyDisplayName(facultyId)}</span>
              ))}
              {symposium.heretic && (
                <span class="special">{getFacultyDisplayName(symposium.heretic)} ‚ú¶</span>
              )}
            </div>
          </div>
        </a>
      ))
    ) : (
      <div class="coming-soon">
        <p class="text-muted">More symposia coming soon...</p>
      </div>
    )}
  </section>

  <section class="principles container">
    <h2>Our Philosophy</h2>
    <div class="principles-grid">
      <div class="principle">
        <h3>Fidelity to Voice</h3>
        <p>Each speaker's contributions reflect their known works, philosophical positions, and rhetorical style.</p>
      </div>
      <div class="principle">
        <h3>Generative Tension</h3>
        <p>Disagreement is not avoided but cultivated; truth emerges through dialectic.</p>
      </div>
      <div class="principle">
        <h3>Open Questions</h3>
        <p>Symposia do not conclude with consensus but with richer questions.</p>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .hero {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: #fafafa;
    padding: var(--space-8) 0;
    text-align: center;
  }

  .hero h1 {
    font-size: 4rem;
    font-weight: 300;
    letter-spacing: 0.2em;
    margin-bottom: var(--space-3);
  }

  .hero-tagline {
    font-size: 1.25rem;
    opacity: 0.9;
    max-width: 500px;
    margin: 0 auto var(--space-4);
  }

  .hero-quote {
    font-style: italic;
    opacity: 0.7;
    font-size: 1rem;
  }

  .intro {
    padding: var(--space-7) var(--space-4);
  }

  .intro h2 {
    margin-bottom: var(--space-4);
  }

  .symposia-list {
    padding: var(--space-6) var(--space-4);
  }

  .symposia-list h2 {
    margin-bottom: var(--space-5);
  }

  .symposium-card {
    display: flex;
    gap: var(--space-4);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: var(--space-5);
    margin-bottom: var(--space-4);
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .symposium-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  }

  .symposium-card-flag {
    font-size: 3rem;
    line-height: 1;
  }

  .symposium-card-content h3 {
    margin-bottom: var(--space-1);
    color: var(--color-text);
  }

  .symposium-card-native {
    font-family: 'Vazirmatn', 'Tahoma', sans-serif;
    font-size: 1.5rem;
    direction: rtl;
    margin-bottom: var(--space-1) !important;
    color: #1a3a5c;
  }

  .symposium-card-subtitle {
    font-style: italic;
    color: var(--color-text-muted);
    margin-bottom: var(--space-3) !important;
  }

  .symposium-card-desc {
    margin-bottom: var(--space-3) !important;
  }

  .symposium-card-speakers {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .symposium-card-speakers span {
    background: var(--color-bg-alt);
    padding: var(--space-1) var(--space-2);
    font-size: 0.85rem;
    border-radius: 2px;
  }

  .symposium-card-speakers .special {
    background: #d4af37;
    color: #1a1a1a;
  }

  /* Persian theme accent for Iran symposium */
  .iran-theme {
    border-left: 4px solid #d4af37;
  }

  /* Absinthe theme accent */
  .absinthe-theme {
    border-left: 4px solid #7fb069;
  }

  .coming-soon {
    text-align: center;
    padding: var(--space-5);
    border: 1px dashed var(--color-border);
  }

  .principles {
    padding: var(--space-6) var(--space-4) var(--space-8);
  }

  .principles h2 {
    margin-bottom: var(--space-5);
  }

  .principles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-4);
  }

  .principle {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: var(--space-4);
  }

  .principle h3 {
    font-size: 1.1rem;
    margin-bottom: var(--space-2);
  }

  .principle p {
    font-size: 0.95rem;
    color: var(--color-text-muted);
    margin-bottom: 0;
  }

  @media (max-width: 768px) {
    .hero h1 {
      font-size: 2.5rem;
    }

    .symposium-card {
      flex-direction: column;
    }

    .symposium-card-flag {
      font-size: 2rem;
    }
  }
</style>

<style is:global>
  @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600&display=swap');
</style>
